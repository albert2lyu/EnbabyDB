{% extends '::base.html.twig' %}

{% block title %}{{book.ISBN}}{%endblock%}

{%block javascript %}
<script type="text/javascript" >  
function joinAudioFiles()
{
	var audios = $("#AudioFiles").find("audio");
	var source = new Array();
	for(var i=0;i<audios.length;i++)
	{
		if(audios[i].getAttribute('data-valid') == 'true')
		{
			source[i] = audios[i].getAttribute('data-src');
		}  		
	}
	return source.join(';');
}

function expandAudioFiles(sources)
{
	var source = sources.split(';');
	for (var i = 0; i < source.length; i++) 
	{
		addAudio(source[i]);
	}
}

function addAudio(source)
{
	if(source!=''){
		var container = $("<div style='position:relative'></div>");
		var removeBtn = $("<button type='button' class='remove-audio-btn btn-xs btn-primary' style='position:absolute;top:0;right:0'><span class='glyphicon glyphicon-trash'></span></button>");
		var audio = $("<audio data-valid='true' controls='controls'></audio>");
		audio.attr('src',source);
		audio.attr('data-src',source);
		container.append(audio);
		container.append(removeBtn);
		$("#AudioFiles").append(container);
	}
}

$(document).ready(function() {
	expandAudioFiles("{{book.AudioFiles}}");
	$(document).on('click','.remove-audio-btn',function  () {
	  	var audio = $(this).siblings("audio");
	  	if(audio.attr('data-valid')=='true') {
	  		audio.attr('data-valid','false');
	  		$(this).removeClass('btn-primary')
	  		$(this).addClass('btn-danger');
	  	}else{
	  		audio.attr('data-valid','true');
	  		$(this).removeClass('btn-danger');
	  		$(this).addClass('btn-primary');
	  	}
	  });


$("#Save").click(function() {
	$.post('{{path("books_update")}}', 
	{
		ISBN : $("#ISBN").val(),
		DisplayName : $("#DisplayName").val(),
		Description : $("#Description").val(),
		LinkToBuy : $("#LinkToBuy").val(),
		Snapshot : $("#Snapshotimg").attr('src'),
		Author : $("#Author").val(),
		AudioFiles: joinAudioFiles(),
		Rank : $("#Rank").val()
	}, 
	function(data, textStatus, xhr) {
	  	alert(textStatus);
	});
});		

$("#Remove").click(function() {
	$.post('{{path("books_remove")}}', 
	{
		ISBN : $("#ISBN").val()
	}, function(data, textStatus, xhr) {
		if(data.MSG =='1')
		{
			alert("Remove successfully!");
		}else{
			alert("Remove failed!");
		}
	});
});	

$("#Link").click(function() {
	var linkSeries = $("#select").val();
	$.post('{{path("links_link")}}', 
		{
			ISBN: $("#ISBN").val(),
			Id: $("#select").val(),
		}, function(data, textStatus, xhr) {
			if(data.MSG == '1')
			{
				var newlinkSeries = $('<tr class="default"><td class="displayName"><a href="/app_dev.php/manager/series/id/' + linkSeries + '">' + $("#" + linkSeries).html() + '</a></td><td><a class="btn-link">unlink</a></td></tr>');
				$("#table").find("tbody").append(newlinkSeries);
				$("#" + linkSeries).remove();
			}else{
				alert("Link not success!");
			}
		/*optional stuff to do after success */
	});
});

	$(document).on('click','.unlink',function  () {
		var unlinkbtn = $(this);
	  	var seriesId = $(this).attr('data-id');
	  	var isbn = $("#ISBN").val();
	  	$.get('{{path("links_unlink")}}',
	  		{
	  			ISBN: isbn,
	  			Id:seriesId,
	  		}, function(data, textStatus, xhr) {
	  		/*optional stuff to do after success */

	  		if(data.MSG == '1')
			{
				var newOption = $("<option></option>");
				newOption.text(unlinkbtn.parent().siblings(".displayName").find("a").html());
				newOption.attr("id",seriesId);
				newOption.attr('value',seriesId);
				$("#select").append(newOption);
				unlinkbtn.parent().parent().remove();
			}else{
				alert("Unlink not success!");
			}

	  	});
	  });


});

function ajaxFileUpload(loadtype)
{
	//starting setting some animation when the ajax starts and completes
	$("#loading")
	.ajaxStart(function(){
		$(this).show();
	})
	.ajaxComplete(function(){
		$(this).hide();
	});
	var uploadUrl;
	if(loadtype == 'Audio') 
	{
		uploadUrl = "{{path('books_audioupload')}}";
	}
	if(loadtype == 'Snapshot') 
	{
		uploadUrl = "{{path('books_snapshotupload')}}";
	}
	$.ajaxFileUpload
	({
		url: uploadUrl, 
		secureuri:false,
		fileElementId:loadtype,
		dataType: 'json',
		success: function (data, status)
		{
			if(typeof(data.MSG) != 'undefined')
			{
				if(data.MSG == '1')
				{
					alert(data.Location);
					if(loadtype == 'Snapshot')
					{
						$("#Snapshotimg").attr('src',data.Location);
					}
					if(loadtype == 'Audio')
					{
						addAudio(data.Location);
					}
				}else
				{
					alert("Upload failed!");
				}
			}
		},
		error: function (data, status, e)
		{
			alert(e);
		}
	})
	return false;
}  
</script>
{% endblock %}

{% block body %}
	<div class="container">

		<div class="page-header">
			
		</div>
		
		
	<div class="col-lg-6">
		<div class="well bs-component">
			<form class="form-horizontal">
				<fieldset>
					<legend>Book Information</legend>
					<div class="form-group">
						<label for="ISBN" class="col-lg-2 control-label">ISBN</label>
						<div class="col-lg-10"><input id='ISBN' class="form-control" value='{{book.ISBN}}' ></div>	
					</div>
					<div class="form-group">
						<label for="DisplayName" class="col-lg-2 control-label">Book</label>
						<div class="col-lg-10"><input  id='DisplayName' class="form-control" value='{{book.DisplayName}}' ></div>
					</div>
					<div class="form-group">
						<label for="Description" class="col-lg-2 control-label">Description</label>
						<div class="col-lg-10"><textarea id='Description' rows='5'  class="form-control" >{{book.Description}}</textarea></div>
					</div>
					<div class="form-group">
						<label for="LinkToBuy" class="col-lg-2 control-label">LinkToBuy</label>
						<div class="col-lg-10"><textarea id='LinkToBuy' rows='3'  class="form-control" >{{book.LinkToBuy | default("www.amazon.cn")}}</textarea></div>
					</div>
					<div class="form-group">
						<label for="Author" class="col-lg-2 control-label">Author</label>
						<div class="col-lg-10"><input id='Author' class="form-control" value='{{book.Author}}'></div>
					</div>
					<div class="form-group">
						<label for="Rank" class="col-lg-2 control-label">Rank</label>
						<div class="col-lg-10"><input id='Rank' class="form-control" value='{{book.Rank | default("100")}}'></div>
					</div>
					<div class="col-lg-10 col-lg-offset-2">
						<a id='Save' class="col-lg-3  btn btn-info">Save</a>
						<a id='Remove' class="col-lg-3 col-lg-offset-1 btn btn-danger">Remove</a>
						<a href="{{path('books_index')}}" class="col-lg-4 col-lg-offset-1 btn btn-warning">Return</a>
					</div>
				</fieldset>
			</form>
		</div>
		<div class="well">
			<fieldset>
				<legend>Link to Series</legend>
				<div class="row bs-component">
					<div class="col-lg-8">
						<select name="select" id="select" class="form-control">
							{% for u in unlink%}
							<option  id='{{u.id}}' value='{{u.id}}'>{{u.displayName}}</option>
							{% endfor%}
						</select>
					</div>
					<div class="col-lg-3 col-lg-offset-1">
						<a id="Link" class="col-lg-10 btn btn-primary">Link</a>
					</div>
				</div>
				<div>
					<label class="divider"></label>
					<table class="table table-striped table-hover" id="table">
						<thead>
							<tr class="info">
								<th>Series</th>
								<th>Unlink</th>
							</tr>
						</thead>
						<tbody>
							{% for l in link %}
								<tr class="default">
									<td class="displayName"><a href="{{path('series_info',{seriesId:l.id})}}">{{l.displayName}}</a></td>
									<td><a class="unlink btn-link" data-id="{{l.id}}">unlink</a></td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>



			</fieldset>
			
		</div>
	</div>

		<div class="col-lg-5 col-lg-offset-1">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Cover</h3>
				</div>
				<div class="panel-body">
					<span class="btn btn-success fileinput-button">
						<i class="glyphicon glyphicon-plus"></i>
						<span>Add files...</span>
					<input id="Snapshot"  type="file"  name="Snapshot">
					</span>
					<button class="btn btn-info" id="SnapshotUpload" onclick="return ajaxFileUpload('Snapshot');">
						<i class="glyphicon glyphicon-upload"></i>
            <span>Start upload</span>
					</button>

					<div>
						<label class="divider"></label>
						<img id='Snapshotimg' src='{{book.Snapshot | default("/img/none.png")}}' width='100%'>
					</div>

				</div>
			</div>
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Audio</h3>
				</div>
				<div class="panel-body">
					<div>
						 <span class="btn btn-success fileinput-button">
							<i class="glyphicon glyphicon-plus"></i>
							<span>Add files...</span>
							<input id="Audio" type="file"  name="Audio" >
						</span>
						<button class="btn btn-info" id="AudioUpload" onclick="return ajaxFileUpload('Audio');">
							<i class="glyphicon glyphicon-upload"></i>
							<span>Start upload</span>
						</button>
					</div>
					<div id="AudioFiles">
					</div>
				</div>
			</div>
		</div>
	</div>
{%endblock%}

